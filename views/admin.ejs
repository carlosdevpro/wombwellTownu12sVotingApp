<%- include('partials/header') %>

<div class="page-center">
  <div class="container">
    <div class="card shadow p-4">
      <h2 class="text-center mb-4">ğŸ›  Admin Dashboard</h2>

      <% if (messages.success) { %>
      <div class="alert alert-success text-center">
        <%= messages.success[0] %>
      </div>
      <% } %> <% if (messages.error) { %>
      <div class="alert alert-danger text-center"><%= messages.error[0] %></div>
      <% } %>

      <div class="d-grid gap-2" style="max-width: 300px; margin: 0 auto">
        <a href="/" class="btn btn-primary w-100">ğŸ  Back to Home</a>

        <form action="/admin/send-reminders" method="POST" class="d-grid">
          <button type="submit" class="btn btn-warning text-black w-100">
            ğŸ“± Send SMS Vote Reminders
          </button>
        </form>

        <form method="POST" action="/admin/submit-parent-motm" class="d-grid">
          <button class="btn btn-danger w-100">ğŸ“£ Reveal winner of MOTM</button>
        </form>

        <button
          class="btn btn-outline-warning w-100"
          data-bs-toggle="modal"
          data-bs-target="#resetParentVotesModal"
        >
          ğŸ” Reset Parent Votes
        </button>

        <a href="/admin/live-match" class="btn btn-outline-success w-100">
          ğŸ“¡ Start Live Match
        </a>

        <a href="/matches" class="btn btn-info w-100">ğŸ“… Match Results</a>

        <a href="/admin/players/new" class="btn btn-success w-100">
          â• Add New Player
        </a>

        <a href="/admin/users" class="btn btn-outline-info mb-3 w-100"
          >ğŸ‘¥ View Registered Users</a
        >
      </div>

      <!-- Registered Parents -->
      <div class="bg-secondary bg-opacity-25 p-3 rounded mb-4">
        <h4 class="text-white bg-primary text-center p-2 rounded">
          ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Registered Parents
        </h4>
        <div class="row g-3 justify-content-center">
          <% parents.forEach(p => { %>
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded bg-dark text-white h-100">
              <p><strong><%= p.firstName %> <%= p.lastName %></strong></p>
              <p>Email: <%= p.email %></p>
              <p>Mobile: <%= p.mobileNumber || 'N/A' %></p>
              <p>
                Linked Player: <%= p.linkedPlayer ? `${p.linkedPlayer.firstName}
                ${p.linkedPlayer.lastName}` : 'None' %>
              </p>
              <p>Voted: <%= p.hasVoted ? 'âœ…' : 'âŒ' %></p>
              <% if (p.lastActive) { %>
              <small>Last Active: <%= p.lastActive.toLocaleString() %></small>
              <% } %>

              <form
                action="/admin/send-reminder/<%= p._id %>"
                method="POST"
                class="mt-2"
              >
                <button class="btn btn-outline-info btn-sm w-100">
                  ğŸ“© Send SMS Reminder
                </button>
              </form>
            </div>
          </div>
          <% }) %>
        </div>
      </div>

      <!-- Registered Players -->
      <div class="bg-secondary bg-opacity-25 p-3 rounded border-0">
        <h4 class="text-white bg-success text-center p-2 rounded">
          âš½ Registered Players
        </h4>
        <div class="row g-3 justify-content-center">
          <% players.forEach(p => { %>
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded bg-dark text-white h-100">
              <p><strong><%= p.firstName %> <%= p.lastName %></strong></p>
              <p>Email: <%= p.email %></p>
              <p>Shirt #: <%= p.linkedPlayer?.shirtNumber || 'N/A' %></p>
              <% if (p.lastActive) { %>
              <small>Last Active: <%= p.lastActive.toLocaleString() %></small>
              <% } %>

              <!-- Delete Button -->
              <button
                type="button"
                class="btn btn-sm btn-danger w-100 mt-2"
                data-bs-toggle="modal"
                data-bs-target="#globalDeletePlayerModal"
                data-player-id="<%= p.linkedPlayer?._id %>"
                data-player-name="<%= p.firstName %> <%= p.lastName %>"
              >
                ğŸ—‘ Delete Player
              </button>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ” Reset Votes Modal -->
<div
  class="modal fade"
  id="resetVotesModal"
  tabindex="-1"
  aria-labelledby="resetVotesLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" action="/admin/reset-votes">
      <div class="modal-content">
        <div class="modal-header">
          <h5
            class="modal-title text-dark text-center fw-bold w-100"
            id="resetVotesLabel"
          >
            Reset All Votes
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body text-dark text-center">
          Are you sure you want to reset the vote status for all parents and
          leaderboard totals?
        </div>
        <div class="modal-footer justify-content-center">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">Reset Votes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ğŸ§¼ Global Delete Player Modal -->
<div
  class="modal fade"
  id="globalDeletePlayerModal"
  tabindex="-1"
  aria-labelledby="globalDeletePlayerLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-dark" id="globalDeletePlayerLabel">
          Confirm Delete
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-dark">
        Are you sure you want to delete
        <strong id="playerNamePlaceholder"></strong> and all linked parents?
      </div>
      <div class="modal-footer">
        <form method="POST" id="deletePlayerForm">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">ğŸ—‘ Confirm Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS for Delete Modal -->
<script>
  const deleteModal = document.getElementById('globalDeletePlayerModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const playerId = button.getAttribute('data-player-id');
    const playerName = button.getAttribute('data-player-name');

    const form = document.getElementById('deletePlayerForm');
    const namePlaceholder = document.getElementById('playerNamePlaceholder');

    form.action = `/admin/players/${playerId}?_method=DELETE`;
    namePlaceholder.textContent = playerName;
  });
</script>

<!-- Reset Parent Votes Modal -->
<div
  class="modal fade"
  id="resetParentVotesModal"
  tabindex="-1"
  aria-labelledby="resetParentVotesModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="resetParentVotesModalLabel">
          âš ï¸ Confirm Vote Reset
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-center">
        <p>Are you sure you want to reset all parent votes?</p>
        <p>This will allow all parents to vote again.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <form action="/admin/reset-parent-votes" method="POST">
          <button type="submit" class="btn btn-warning">Yes, Reset</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  // Automatically hide flash messages after 4 seconds
  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) {
      alert.classList.add('fade');
      setTimeout(() => alert.remove(), 500); // wait for fade animation to finish
    }
  }, 4000);
</script>
