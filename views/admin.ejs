<%- include('partials/header') %>

<div class="page-center">
  <div class="container">
    <div class="card shadow p-4">
      <h2 class="text-center mb-4">🛠 Admin Dashboard</h2>

      <% if (messages.success) { %>
      <div class="alert alert-success text-center">
        <%= messages.success[0] %>
      </div>
      <% } %> <% if (messages.error) { %>
      <div class="alert alert-danger text-center"><%= messages.error[0] %></div>
      <% } %>

      <div class="d-grid gap-3 mb-4" style="max-width: 300px; margin: 0 auto">
        <a href="/" class="btn btn-primary w-100">🏠 Back to Home</a>
        <form action="/admin/send-reminders" method="POST" class="w-100">
          <button type="submit" class="btn btn-warning text-black w-100">
            📱 Send SMS Vote Reminders
          </button>
        </form>
        <button
          class="btn btn-danger w-100"
          data-bs-toggle="modal"
          data-bs-target="#resetVotesModal"
        >
          🔄 Reset All Votes
        </button>
        <a href="/admin/reset-stats" class="btn btn-outline-danger w-100"
          >🧨 Reset Player Stats (Secure)</a
        >
        <a href="/admin/create-match" class="btn btn-outline-success w-100"
          >✍️ Create Match Result</a
        >
        <a href="/matches" class="btn btn-info w-100">📅 Edit Match Results</a>
      </div>

      <!-- Registered Parents -->
      <div class="bg-secondary bg-opacity-25 p-3 rounded mb-4">
        <h4 class="text-white bg-primary text-center p-2 rounded">
          👨‍👩‍👧 Registered Parents
        </h4>
        <div class="row g-3 justify-content-center">
          <% parents.forEach(p => { %>
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded bg-dark text-white h-100">
              <p><strong><%= p.firstName %> <%= p.lastName %></strong></p>
              <p>Email: <%= p.email %></p>
              <p>Mobile: <%= p.mobileNumber || 'N/A' %></p>
              <p>
                Linked Player: <%= p.linkedPlayer ? `${p.linkedPlayer.firstName}
                ${p.linkedPlayer.lastName}` : 'None' %>
              </p>
              <p>Voted: <%= p.hasVoted ? '✅' : '❌' %></p>
              <% if (p.lastActive) { %>
              <small>Last Active: <%= p.lastActive.toLocaleString() %></small>
              <% } else { %>
              <small><em>Last Active: Not recorded</em></small>
              <% } %>
              <form
                action="/admin/send-reminder/<%= p._id %>"
                method="POST"
                class="mt-2"
              >
                <button class="btn btn-outline-info btn-sm w-100">
                  📩 Send SMS Reminder
                </button>
              </form>
            </div>
          </div>
          <% }) %>
        </div>
      </div>

      <!-- Registered Players -->
      <div class="bg-secondary bg-opacity-25 p-3 rounded border-0">
        <h4 class="text-white bg-success text-center p-2 rounded">
          ⚽ Registered Players
        </h4>
        <div class="row g-3 justify-content-center">
          <% players.forEach(p => { %>
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded bg-dark text-white h-100">
              <p><strong><%= p.firstName %> <%= p.lastName %></strong></p>
              <p>Email: <%= p.email %></p>
              <p>Shirt #: <%= p.linkedPlayer?.shirtNumber || 'N/A' %></p>
              <% if (p.lastActive) { %>
              <small>Last Active: <%= p.lastActive.toLocaleString() %></small>
              <% } else { %>
              <small><em>Last Active: Not recorded</em></small>
              <% } %>
              <button
                type="button"
                class="btn btn-sm btn-danger w-100 mt-2"
                data-bs-toggle="modal"
                data-bs-target="#globalDeletePlayerModal"
                data-player-id="<%= p.linkedPlayer?._id %>"
                data-player-name="<%= p.firstName %> <%= p.lastName %>"
              >
                🗑 Delete Player
              </button>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 🔁 Reset Votes Modal -->
<div
  class="modal fade"
  id="resetVotesModal"
  tabindex="-1"
  aria-labelledby="resetVotesLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" action="/admin/reset-votes">
      <div class="modal-content">
        <div class="modal-header">
          <h5
            class="modal-title text-dark text-center fw-bold w-100"
            id="resetVotesLabel"
          >
            Reset All Votes
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body text-dark text-center">
          Are you sure you want to reset the vote status for all parents and
          leaderboard totals?
        </div>
        <div class="modal-footer justify-content-center">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">Reset Votes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- 🧼 Global Delete Player Modal -->
<div
  class="modal fade"
  id="globalDeletePlayerModal"
  tabindex="-1"
  aria-labelledby="globalDeletePlayerLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-dark" id="globalDeletePlayerLabel">
          Confirm Delete
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-dark">
        Are you sure you want to delete
        <strong id="playerNamePlaceholder"></strong> and all linked parents?
      </div>
      <div class="modal-footer">
        <form method="POST" id="deletePlayerForm">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">🗑 Confirm Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS to handle global delete -->
<script>
  const deleteModal = document.getElementById('globalDeletePlayerModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const playerId = button.getAttribute('data-player-id');
    const playerName = button.getAttribute('data-player-name');

    const form = document.getElementById('deletePlayerForm');
    const namePlaceholder = document.getElementById('playerNamePlaceholder');

    form.action = `/admin/players/${playerId}?_method=DELETE`;
    namePlaceholder.textContent = playerName;
  });
</script>

<%- include('partials/footer') %>
